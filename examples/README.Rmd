---
output: github_document
---

```{r setup, include = FALSE}
print_yaml <- function(filename) {
  cat("```yaml", readLines(filename), "```", sep = "\n")
}
```

- [Quickstart CI](#quickstart-ci-workflow) - A simple CI workflow to check with the release version of R.
- [Tidyverse CI](#tidyverse-ci-workflow) - A more complex CI workflow
- [Pull Request Commands](#commands-workflow) - Adds `/document` and `/style` commands for pull requests.
- [Render README](#render-readme) - Render README.Rmd when it changes and commit the result
- [Build pkgdown site](#build-pkgdown-site) - Build a [pkgdown] site for an R package and deploy it to [GitHub Pages].
- [Build bookdown site](#build-bookdown-site) - Build a [bookdown] site and deploy it to [netlify].
- [Build blogdown site](#build-blogdown-site) - Build a [blogdown] site and deploy it to [netlify].

## Quickstart CI workflow

This workflow installs latest release R version on macOS
and runs R CMD check via the [rcmdcheck](https://github.com/r-lib/rcmdcheck)
package.

### When can it be used?

1. You have a simple R package
2. There is no OS-specific code
3. You want a quick start with R CI

```{r echo = FALSE, results = "asis"}
print_yaml("check-release.yaml")
```

## Tidyverse CI workflow

This workflow installs the last 5 minor R versions
and runs R CMD check via the [rcmdcheck](https://github.com/r-lib/rcmdcheck)
package on the three major OSs (linux, macOS and Windows). This workflow is
what the tidyverse teams uses on their repositories, but is overkill
for less widely used packages, which are better off using the simpler
quickstart CI workflow.

## When it can be used?

1. You have a complex R package
2. With OS-specific code
3. And you want to ensure compatibility with older R versions

```{r echo = FALSE, results = "asis"}
print_yaml("check-full.yaml")
```

## Commands workflow

This workflow enables the use of 2 R specific commands in pull request issue
comments. `/document` will use [roxygen2](https://roxygen2.r-lib.org/) to
rebuild the documentation for the package and commit the result to the pull
request. `/style` will use [styler](https://styler.r-lib.org/) to restyle your
package.

## When it can they be used?

1. You get frequent pull requests, often with documentation only fixes.
2. You regularly style your code with styler, and require all additions be
   styled as well.

```{r echo = FALSE, results = "asis"}
print_yaml("pr-commands.yaml")
```

## Render README

This example automatically re-builds this README.md from README.Rmd whenever it
or its yaml dependencies change and commits the results to the master branch.

```{r echo = FALSE, results = "asis"}
print_yaml("render-readme.yaml")
```

## Build pkgdown site

This example builds a [pkgdown](https://pkgdown.r-lib.org/) site for a 
repository and pushes the built package to [GitHub Pages]. 

**Note** you need 
to add a `DEPLOY_PAT` secret to your repository, however this personal access 
token _only_ needs the `public_repo` scope, as well as have a `gh-pages` 
branch in your git repository. 

In this context:

  - *your repository* is the GitHub package-repository for which 
  you want to deploy a pkgdown site
  - `{repo}` is the name of your repository,
  - `{user}` is your GitHub user name or organization name, as the case may be.

1. Open a couple of web pages at GitHub:

   - Your account's **tokens** page: <https://github.com/settings/tokens>.
   - Your repository's **secrets** page: 
    `https://github.com/{user}/{repo}/settings/secrets`

2. Create a Personal Access Token (PAT) at your account's **tokens** page.

   - The only scope that this PAT needs is `public_repo`.
   - You may wish to name the token `pkgdown-{repo}`. 
   - As soon as you have created the PAT, save it to your clipboard.

3. On your repository's **secrets** page:

   - Click "Add a new secret".
   - In the "Name" field, type `DEPLOY_PAT`.
   - In the "Value" field, paste the PAT from your clipboard.
   - Click "Add Secret".
  
4. At this point (certainly at some point), you may wish to close your 
  **tokens** page to remove the visibility of your PAT.

Your pkgdown site will be deployed on the `gh-pages` branch of your
repository. Paraphrasing from the 
[pkgdown documentation](https://pkgdown.r-lib.org/reference/deploy_site_github.html#setup),
you need to make sure that a `gh-pages` branch exists. 
The simplest way to do so is to run the following git commands locally:
  
```
git checkout --orphan gh-pages
git rm -rf .
git commit --allow-empty -m 'Initial gh-pages commit'
git push origin gh-pages
git checkout master
```

We recommend doing this outside of RStudio (with the project closed) 
as from RStudio's perspective you end up deleting all the files and then 
re-creating them.

At this point, upon the next push to the `master` branch at GitHub, the action
will build and deploy your pkgdown site. At your repository's settings page
(`https://github.com/{user}/{repo}/settings`), you will want to make sure that 
the "source" for your repository's GitHub pages is set to "gh-pages branch". 

```{r echo = FALSE, results = "asis"}
print_yaml("pkgdown.yaml")
```

## Build bookdown site

This example builds a [bookdown] site for a repository and then deploys the book via [netlify].
It uses [renv] to ensure the package versions remain consistent across builds.
You will need to run `renv::snapshot()` locally and commit the `renv.lock` file before using this workflow, see [Using renv with Continous Integeration](https://rstudio.github.io/renv/articles/ci.html) for additional information.
**Note** you need to add a `NETLIFY_AUTH_TOKEN` secret to your repository for the netlify deploy.

```{r echo = FALSE, results = "asis"}
print_yaml("bookdown.yaml")
```

## Build blogdown site

This example builds a [blogdown] site for a repository and then deploys the book via [netlify].
It uses [renv] to ensure the package versions remain consistent across builds.
You will need to run `renv::snapshot()` locally and commit the `renv.lock` file before using this workflow, see [Using renv with Continous Integeration](https://rstudio.github.io/renv/articles/ci.html) for additional information.
**Note** you need to add a `NETLIFY_AUTH_TOKEN` secret to your repository for the netlify deploy.

```{r echo = FALSE, results = "asis"}
print_yaml("blogdown.yaml")
```

[GitHub Pages]: https://pages.github.com/
[renv]: https://rstudio.github.io/renv/
[bookdown]: https://bookdown.org
[blogdown]: https://bookdown.org/yihui/blogdown/
[netlify]: https://www.netlify.com/
